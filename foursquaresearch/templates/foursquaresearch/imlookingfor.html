{% extends 'foursquaresearch/base.html' %}
{% load i18n %}
{% load custom_filters %}
{% block javascript %}
    <script>
        $('.addToFavorite').each(addFavorite);
        $('.removeFromFavorite').each(removeFavorite);

        function addFavorite() {
            $(this).submit(function(event) {
                event.preventDefault();

                var form = $(this);
                var postData = $(this).serializeArray();
                var formURL = "{% url 'add_to_favorites' %}";

                $.ajax({
                    url: formURL,
                    type: "POST",
                    data: postData,
                    success: function (data, textStatus, jqXHR) {
                        if (data.favorite_exist) {
                            alert("Something went wrong! It should have turn you to a warewolf!");

                        } else {
                            removeFromFavoriteForm = "<form id=\""+postData[0].value+"\" class='removeFromFavorite'>\n" +
                                "<input type=\"hidden\" name=\"id\" value=\""+postData[0].value+"\"/>\n" +
                                "<input type=\"hidden\" name=\"name\" value=\""+postData[1].value+"\"/>\n" +
                                "<input type=\"hidden\" name=\"location\" value=\""+postData[2].value+"\"/>\n" +
                                "<button class=\"btn-link remove-favorite\">DEL</button>\n" +
                                "</form>"
                            form.replaceWith(removeFromFavoriteForm);
                            console.log(document.getElementById(postData[0].value));
                            document.getElementById(postData[0].value).addEventListener("submit", removeFavorite());

                        }
                    }
                });
            });
        };

        function removeFavorite() {
            $(this).submit(function(event) {
                event.preventDefault();

                var form = $(this);
                var postData = $(this).serializeArray();
                var formURL = "{% url 'remove_from_favorites_while_searching' %}";
                $.ajax({
                    url: formURL,
                    type: "POST",
                    data: postData,

                    success: function (data, textStatus, jqXHR) {
                        if (data.status) {
                            addToFavoriteForm = "<form id=\""+postData[0].value+"\" class='addToFavorite'>\n" +
                                "<input type=\"hidden\" name=\"id\" value=\""+postData[0].value+"\"/>\n" +
                                "<input type=\"hidden\" name=\"name\" value=\""+postData[1].value+"\"/>\n" +
                                "<input type=\"hidden\" name=\"location\" value=\""+postData[2].value+"\"/>\n" +
                                "<button class=\"btn-link add-fav\">FAV</button>\n" +
                                "</form>"
                            form.replaceWith(addToFavoriteForm);
                            document.getElementById(postData[0].value).addEventListener("submit", addFavorite());

                        } else {
                            alert("Something went wrong! It should have turn you to a vampire!");
                        }

                    }

                });
            });
        };

    </script>
{% endblock %}

{% block search %}
    {% if is_searched %}
        <div class="col-sm-1">
        </div>
        <div class="col-sm-5">
            <h3> Results for {{ what_to_look|capfirst }} in {{ location|capfirst }}
                <br><br></h3>
            <table class="table table-bordered">
                <tr>
                    <th>Name</th>
                    <th>Checkins</th>
                </tr>
                {% for venue in venues %}
                    <tr data-id="{{ venue.id }}">
                        <!-- Button trigger modal -->
                        <td class ='place-name'>
                            <!-- Button trigger modal -->
                            <button type="button" class="btn btn-primary btn-xs" data-toggle="modal" data-target="#myModal-{{venue.id}}">
                                {{ venue.name }}
                            </button>
                            <!-- Modal -->
                            <div class="modal fade" id="myModal-{{venue.id}}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                            <h4 class="modal-title" id="myModalLabel">Details</h4>
                                        </div>
                                        <div class="modal-body">
                                            <table class="table table-bordered">
                                                <tr>
                                                    <td>Checkins Count: </td>
                                                    <td>{{ venue.stats.checkinsCount }}</td>
                                                </tr>
                                                <tr>
                                                    <td>Currently: </td>
                                                    <td>{{ venue.hereNow.summary }}</td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>{{ venue.stats.checkinsCount }}</td>
                        <td class='place-address'>{{ venue.location.address }}</td>
                        {% if logged_in %}
                            <td>
                                <div class="favorite-module">
                                    {% if venue.id in favorite_list %}
                                        <form id="{{ venue.id }}" class='removeFromFavorite'>
                                            <input type="hidden" name="id" value="{{ venue.id }}"/>
                                            <input type="hidden" name="name" value="{{ venue.name }}"/>
                                            <input type="hidden" name="location" value="{{ venue.location.address }}"/>
                                            <button class="btn-link remove-favorite">DEL</button>
                                        </form>
                                    {% else %}
                                        <form id="{{ venue.id }}" class='addToFavorite'>
                                            <input type="hidden" name="id" value="{{ venue.id }}"/>
                                            <input type="hidden" name="name" value="{{ venue.name }}"/>
                                            <input type="hidden" name="location" value="{{ venue.location.address }}"/>
                                            <button class="btn-link add-fav">FAV</button>
                                        </form>
                                    {% endif %}
                                </div>
                            </td>
                        {% endif %}
                    </tr>
                {% endfor %}
            </table>
        </div>
        <div class="col-sm-1">
        </div>
    {% elif not is_searched %}
        <div class="col-sm-1">
        </div>
        <div class="col-sm-6">
            <br>
            {{error}}<br>
        </div>
    {% endif %}

{% endblock %}
